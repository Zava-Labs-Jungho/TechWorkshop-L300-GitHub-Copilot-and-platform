@model List<ZavaStorefront.Models.ChatMessage>
@{
    ViewData["Title"] = "Chat with AI Assistant";
}

<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots me-2"></i>AI Shopping Assistant
                    <small class="opacity-75">(Powered by Phi-4)</small>
                </h5>
                <form asp-action="ClearHistory" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-light" title="Clear chat history">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </form>
            </div>

            <div id="chatArea" class="card-body" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                @if (Model.Count == 0)
                {
                    <div id="welcomeMessage" class="text-center text-muted py-5">
                        <i class="bi bi-robot" style="font-size: 3rem;"></i>
                        <p class="mt-3">Hello! I'm your AI shopping assistant. How can I help you today?</p>
                    </div>
                }
                else
                {
                    foreach (var message in Model)
                    {
                        if (message.Role == "user")
                        {
                            <div class="d-flex justify-content-end mb-3">
                                <div class="bg-primary text-white rounded-3 px-3 py-2" style="max-width: 75%;">
                                    <p class="mb-0">@message.Content</p>
                                    <small class="opacity-75">@message.Timestamp.ToString("HH:mm")</small>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-content-start mb-3">
                                <div class="bg-white border rounded-3 px-3 py-2" style="max-width: 75%;">
                                    <p class="mb-0">@message.Content</p>
                                    <small class="text-muted">@message.Timestamp.ToString("HH:mm")</small>
                                </div>
                            </div>
                        }
                    }
                }
            </div>

            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="Type your message..."
                           autocomplete="off" />
                    <button id="sendButton" class="btn btn-primary" type="button">
                        <i class="bi bi-send"></i> Send
                    </button>
                </div>
                <div id="errorAlert" class="alert alert-danger mt-2 d-none" role="alert"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatArea = document.getElementById('chatArea');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const errorAlert = document.getElementById('errorAlert');
        const welcomeMessage = document.getElementById('welcomeMessage');

        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function appendMessage(role, content) {
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let html = '';

            if (role === 'user') {
                html = `<div class="d-flex justify-content-end mb-3">
                    <div class="bg-primary text-white rounded-3 px-3 py-2" style="max-width: 75%;">
                        <p class="mb-0">${escapeHtml(content)}</p>
                        <small class="opacity-75">${time}</small>
                    </div>
                </div>`;
            } else {
                html = `<div class="d-flex justify-content-start mb-3">
                    <div class="bg-white border rounded-3 px-3 py-2" style="max-width: 75%;">
                        <p class="mb-0">${escapeHtml(content)}</p>
                        <small class="text-muted">${time}</small>
                    </div>
                </div>`;
            }

            chatArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const html = `<div id="typingIndicator" class="d-flex justify-content-start mb-3">
                <div class="bg-white border rounded-3 px-3 py-2">
                    <div class="typing-dots">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>
            </div>`;
            chatArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            errorAlert.classList.add('d-none');

            appendMessage('user', message);
            showTypingIndicator();

            try {
                const response = await fetch('@Url.Action("SendMessage", "Chat")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                removeTypingIndicator();

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                const data = await response.json();
                appendMessage('assistant', data.content);
            } catch (error) {
                removeTypingIndicator();
                errorAlert.textContent = 'Failed to send message. Please try again.';
                errorAlert.classList.remove('d-none');
                console.error('Chat error:', error);
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        scrollToBottom();
        messageInput.focus();
    </script>

    <style>
        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }
        .typing-dots .dot {
            width: 8px;
            height: 8px;
            background-color: #6c757d;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        .typing-dots .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots .dot:nth-child(3) { animation-delay: 0.4s; }
        @@keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
}
